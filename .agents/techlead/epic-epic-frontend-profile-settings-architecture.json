{
  "_metadata": {
    "agentType": "techlead",
    "taskId": "1ebf92ad00258e0d4f08a5f4",
    "timestamp": "2026-01-31T14:09:06.660Z",
    "phase": "techlead",
    "epicId": "epic-frontend-profile-settings",
    "savedAt": "2026-01-31T14:09:06.660Z",
    "version": "1.0"
  },
  "data": {
    "epicId": "epic-frontend-profile-settings",
    "storiesCount": 3,
    "architecture": "## Architecture Overview\n\nThis epic implements Profile and Settings features following the existing Clean Architecture pattern in the codebase.\n\n### Layer Structure (per feature):\n```\nlib/features/{feature}/\n‚îú‚îÄ‚îÄ domain/\n‚îÇ   ‚îú‚îÄ‚îÄ entities/        # Pure domain objects (Equatable)\n‚îÇ   ‚îú‚îÄ‚îÄ repositories/    # Abstract interfaces\n‚îÇ   ‚îî‚îÄ‚îÄ usecases/        # Single-responsibility use cases\n‚îú‚îÄ‚îÄ data/\n‚îÇ   ‚îú‚îÄ‚îÄ datasources/     # Remote/Local data sources\n‚îÇ   ‚îú‚îÄ‚îÄ models/          # JSON serializable models\n‚îÇ   ‚îî‚îÄ‚îÄ repositories/    # Interface implementations\n‚îî‚îÄ‚îÄ presentation/\n    ‚îú‚îÄ‚îÄ bloc/            # BLoC state management\n    ‚îú‚îÄ‚îÄ pages/           # Screen widgets\n    ‚îî‚îÄ‚îÄ widgets/         # Reusable UI components\n```\n\n### Key Patterns Discovered:\n\n1. **BLoC Pattern**: Uses sealed classes for events/states with Equatable\n2. **Dependency Injection**: get_it with sl<T>() pattern, lazy singletons for services, factories for BLoCs\n3. **Repository Pattern**: Abstract interfaces in domain, implementations in data layer\n4. **API Client**: Centralized ApiClient with interceptors for auth/error handling\n5. **Storage**: SecureStorageService for persisting sensitive/settings data\n6. **Routing**: GoRouter with BlocProvider wrappers for each route\n\n### Profile Feature Design:\n- Reuses existing User entity from auth feature\n- Uses ApiEndpoints.userProfile (GET) and ApiEndpoints.updateProfile (PUT)\n- ProfileBloc manages view/edit modes with ProfileLoaded/ProfileEditing states\n\n### Settings Feature Design:\n- Creates new AppSettings entity with ThemeMode enum\n- Uses SecureStorageService for local persistence (no backend API)\n- SettingsBloc handles toggle/selection changes with immediate persistence\n\n### Verification Commands:\n- Typecheck: `flutter analyze`\n- Build: `flutter build apk --debug`\n- Test: `flutter test`",
    "stories": [
      {
        "id": "epic-frontend-profile-settings-story-1",
        "title": "Create Profile feature files in lib/features/profile/ with domain, data, and presentation layers",
        "description": "Create the complete Profile feature following Clean Architecture pattern.\n\nüîí **SCOPE BOUNDARY:**\n- You can ONLY create files in lib/features/profile/\n- DO NOT modify any files in lib/core/\n\nüìÅ **FILES:**\n- Read (for patterns): lib/features/auth/presentation/bloc/auth_bloc.dart, lib/features/auth/domain/repositories/auth_repository.dart, lib/features/auth/data/repositories/auth_repository_impl.dart, lib/features/auth/data/datasources/auth_remote_datasource.dart, lib/features/auth/domain/usecases/login_usecase.dart, lib/features/auth/domain/entities/user.dart, lib/features/auth/data/models/user_model.dart\n- Create: lib/features/profile/domain/repositories/profile_repository.dart, lib/features/profile/domain/usecases/get_profile_usecase.dart, lib/features/profile/domain/usecases/update_profile_usecase.dart, lib/features/profile/data/datasources/profile_remote_datasource.dart, lib/features/profile/data/repositories/profile_repository_impl.dart, lib/features/profile/presentation/bloc/profile_bloc.dart, lib/features/profile/presentation/bloc/profile_event.dart, lib/features/profile/presentation/bloc/profile_state.dart, lib/features/profile/presentation/pages/profile_page.dart\n\nüîß **PATTERNS TO USE:**\n\n**Domain Repository Interface (from auth_repository.dart):**\n```dart\nabstract interface class ProfileRepository {\n  Future<User> getProfile();\n  Future<User> updateProfile({String? name, String? email});\n}\n```\n\n**UseCase Pattern (from login_usecase.dart):**\n```dart\nclass GetProfileUseCase {\n  GetProfileUseCase({required ProfileRepository repository}) : _repository = repository;\n  final ProfileRepository _repository;\n  Future<User> call() => _repository.getProfile();\n}\n```\n\n**Remote Datasource Pattern (from auth_remote_datasource.dart):**\n```dart\nabstract interface class ProfileRemoteDatasource {\n  Future<UserModel> getProfile();\n  Future<UserModel> updateProfile({String? name, String? email});\n}\n\nclass ProfileRemoteDatasourceImpl implements ProfileRemoteDatasource {\n  ProfileRemoteDatasourceImpl({required ApiClient client}) : _client = client;\n  final ApiClient _client;\n  // Use ApiEndpoints.userProfile and ApiEndpoints.updateProfile\n}\n```\n\n**BLoC Pattern (from auth_bloc.dart):**\n- Use sealed classes for events and states with Equatable\n- Inject use cases via constructor\n- Handle errors with AppException types\n- States: ProfileInitial, ProfileLoading, ProfileLoaded, ProfileEditing, ProfileUpdateSuccess, ProfileError\n- Events: ProfileLoadRequested, ProfileEditModeToggled, ProfileUpdateRequested, ProfileCancelEditRequested\n\n**Profile Page Pattern (from login_page.dart):**\n- Use BlocConsumer for state management\n- Show SnackBar for errors and success\n- Use Validators.email and Validators.required for form validation\n- Use Theme.of(context) for styling\n\n**REUSE EXISTING User Entity:**\n- Import User from 'package:app_pasos_frontend/features/auth/domain/entities/user.dart'\n- Import UserModel from 'package:app_pasos_frontend/features/auth/data/models/user_model.dart'\n- DO NOT create new user entity/model\n\n‚ö†Ô∏è **ANTI-PATTERNS TO AVOID:**\n- Creating new User/UserModel classes - REUSE existing ones from auth feature\n- Using fetch() directly - USE ApiClient from core/network/api_client.dart\n- Hardcoding API paths - USE ApiEndpoints constants\n- Using Text('Coming Soon') or placeholder widgets - IMPLEMENT fully functional UI\n- Modifying files outside lib/features/profile/ - SCOPE VIOLATION\n\nüéØ **FUNCTIONAL REQUIREMENTS:**\n- ProfilePage displays current username, email, join date from User entity\n- Edit button toggles ProfileEditing state with editable TextFormFields\n- Save button validates form (Validators.required for name, Validators.email for email) and dispatches ProfileUpdateRequested\n- Cancel button dispatches ProfileCancelEditRequested and reverts to ProfileLoaded state\n- Success shows SnackBar with 'Profile updated successfully' and updates displayed data\n- Error shows SnackBar with error message and retry option via RefreshIndicator\n- Loading state shows CircularProgressIndicator\n\nüß™ **VERIFICATION:**\n- Run: flutter analyze lib/features/profile/\n- Check: All imports resolve correctly\n- Check: No 'Coming Soon' or placeholder text\n- Check: Form validation uses Validators class",
        "epicId": "epic-frontend-profile-settings",
        "priority": 1,
        "estimatedComplexity": "moderate",
        "dependencies": [],
        "status": "pending",
        "filesToRead": [
          "lib/features/auth/presentation/bloc/auth_bloc.dart",
          "lib/features/auth/presentation/bloc/auth_event.dart",
          "lib/features/auth/presentation/bloc/auth_state.dart",
          "lib/features/auth/domain/repositories/auth_repository.dart",
          "lib/features/auth/data/repositories/auth_repository_impl.dart",
          "lib/features/auth/data/datasources/auth_remote_datasource.dart",
          "lib/features/auth/domain/usecases/login_usecase.dart",
          "lib/features/auth/domain/entities/user.dart",
          "lib/features/auth/data/models/user_model.dart",
          "lib/features/auth/presentation/pages/login_page.dart",
          "lib/core/network/api_client.dart",
          "lib/core/network/api_endpoints.dart",
          "lib/core/utils/validators.dart",
          "lib/core/errors/app_exceptions.dart"
        ],
        "filesToModify": [],
        "filesToCreate": [
          "lib/features/profile/domain/repositories/profile_repository.dart",
          "lib/features/profile/domain/usecases/get_profile_usecase.dart",
          "lib/features/profile/domain/usecases/update_profile_usecase.dart",
          "lib/features/profile/data/datasources/profile_remote_datasource.dart",
          "lib/features/profile/data/repositories/profile_repository_impl.dart",
          "lib/features/profile/presentation/bloc/profile_bloc.dart",
          "lib/features/profile/presentation/bloc/profile_event.dart",
          "lib/features/profile/presentation/bloc/profile_state.dart",
          "lib/features/profile/presentation/pages/profile_page.dart"
        ],
        "acceptanceCriteria": [
          "Given a logged-in user, When they navigate to ProfilePage, Then their username, email, and join date are displayed",
          "Given ProfilePage is in view mode, When user taps Edit button, Then form becomes editable with TextFormFields",
          "Given ProfilePage is in edit mode, When user changes name/email and taps Save, Then form validates and updates profile via API",
          "Given ProfilePage is in edit mode, When user taps Cancel, Then form reverts to view mode with original data",
          "Given a successful profile update, When API returns success, Then SnackBar shows success message and data updates",
          "Given an API error occurs, When update fails, Then SnackBar shows error message with retry option"
        ]
      },
      {
        "id": "epic-frontend-profile-settings-story-2",
        "title": "Create Settings feature files in lib/features/settings/ with domain, data, and presentation layers",
        "description": "Create the complete Settings feature following Clean Architecture pattern with local persistence.\n\nüîí **SCOPE BOUNDARY:**\n- You can ONLY create files in lib/features/settings/\n- DO NOT modify any files in lib/core/ or lib/features/profile/\n\nüìÅ **FILES:**\n- Read (for patterns): lib/features/auth/presentation/bloc/auth_bloc.dart, lib/core/storage/secure_storage_service.dart, lib/core/theme/app_theme.dart\n- Create: lib/features/settings/domain/entities/app_settings.dart, lib/features/settings/domain/repositories/settings_repository.dart, lib/features/settings/data/repositories/settings_repository_impl.dart, lib/features/settings/presentation/bloc/settings_bloc.dart, lib/features/settings/presentation/bloc/settings_event.dart, lib/features/settings/presentation/bloc/settings_state.dart, lib/features/settings/presentation/pages/settings_page.dart\n\nüîß **PATTERNS TO USE:**\n\n**Settings Entity:**\n```dart\nimport 'package:equatable/equatable.dart';\n\nenum ThemeMode { light, dark, system }\n\nclass AppSettings extends Equatable {\n  const AppSettings({\n    this.notificationsEnabled = true,\n    this.themeMode = ThemeMode.system,\n  });\n  \n  final bool notificationsEnabled;\n  final ThemeMode themeMode;\n  \n  AppSettings copyWith({bool? notificationsEnabled, ThemeMode? themeMode}) {\n    return AppSettings(\n      notificationsEnabled: notificationsEnabled ?? this.notificationsEnabled,\n      themeMode: themeMode ?? this.themeMode,\n    );\n  }\n  \n  @override\n  List<Object?> get props => [notificationsEnabled, themeMode];\n}\n```\n\n**Repository Interface:**\n```dart\nabstract interface class SettingsRepository {\n  Future<AppSettings> getSettings();\n  Future<void> saveSettings(AppSettings settings);\n  Future<void> updateNotificationsEnabled(bool enabled);\n  Future<void> updateThemeMode(ThemeMode mode);\n}\n```\n\n**Repository Implementation (uses SecureStorageService pattern):**\n```dart\nclass SettingsRepositoryImpl implements SettingsRepository {\n  SettingsRepositoryImpl({required SecureStorageService storage}) : _storage = storage;\n  final SecureStorageService _storage;\n  \n  static const _notificationsKey = 'settings_notifications_enabled';\n  static const _themeModeKey = 'settings_theme_mode';\n  \n  @override\n  Future<AppSettings> getSettings() async {\n    final notificationsStr = await _storage.read(_notificationsKey);\n    final themeModeStr = await _storage.read(_themeModeKey);\n    return AppSettings(\n      notificationsEnabled: notificationsStr != 'false',\n      themeMode: _parseThemeMode(themeModeStr),\n    );\n  }\n  // ... implement other methods\n}\n```\n\n**BLoC Pattern:**\n- States: SettingsInitial, SettingsLoading, SettingsLoaded(settings), SettingsError(message)\n- Events: SettingsLoadRequested, SettingsNotificationToggled(enabled), SettingsThemeModeChanged(mode)\n\n**Settings Page UI:**\n- SwitchListTile for notifications toggle\n- SegmentedButton or RadioListTile for theme selection (Light/Dark/System)\n- Use ListTile with leading icons for each setting\n- Group settings in Card widgets with headers\n\n‚ö†Ô∏è **ANTI-PATTERNS TO AVOID:**\n- Using SharedPreferences directly - USE SecureStorageService\n- Hardcoding storage keys without constants - DEFINE static const keys\n- Using Text('Coming Soon') or placeholder widgets - IMPLEMENT fully functional UI\n- Creating files outside lib/features/settings/ - SCOPE VIOLATION\n- Using Navigator directly - USE GoRouter context.go() or context.push()\n\nüéØ **FUNCTIONAL REQUIREMENTS:**\n- SettingsPage displays notification toggle (SwitchListTile)\n- SettingsPage displays theme selector (Light/Dark/System using SegmentedButton)\n- Toggle state persists to SecureStorageService immediately on change\n- Theme selection persists to SecureStorageService immediately on change\n- Settings load from storage on page init via SettingsLoadRequested event\n- Loading state shows LoadingIndicator widget from shared/widgets/\n- Error state shows ErrorWidget from shared/widgets/ with retry\n\nüß™ **VERIFICATION:**\n- Run: flutter analyze lib/features/settings/\n- Check: All imports resolve correctly\n- Check: No 'Coming Soon' or placeholder text\n- Check: Settings persist using SecureStorageService.read/write",
        "epicId": "epic-frontend-profile-settings",
        "priority": 1,
        "estimatedComplexity": "moderate",
        "dependencies": [],
        "status": "pending",
        "filesToRead": [
          "lib/features/auth/presentation/bloc/auth_bloc.dart",
          "lib/features/auth/presentation/bloc/auth_event.dart",
          "lib/features/auth/presentation/bloc/auth_state.dart",
          "lib/core/storage/secure_storage_service.dart",
          "lib/core/theme/app_theme.dart",
          "lib/shared/widgets/loading_indicator.dart",
          "lib/shared/widgets/error_widget.dart"
        ],
        "filesToModify": [],
        "filesToCreate": [
          "lib/features/settings/domain/entities/app_settings.dart",
          "lib/features/settings/domain/repositories/settings_repository.dart",
          "lib/features/settings/data/repositories/settings_repository_impl.dart",
          "lib/features/settings/presentation/bloc/settings_bloc.dart",
          "lib/features/settings/presentation/bloc/settings_event.dart",
          "lib/features/settings/presentation/bloc/settings_state.dart",
          "lib/features/settings/presentation/pages/settings_page.dart"
        ],
        "acceptanceCriteria": [
          "Given SettingsPage loads, When settings are retrieved from storage, Then notification toggle reflects stored value",
          "Given SettingsPage loads, When settings are retrieved from storage, Then theme selector reflects stored value",
          "Given user toggles notification switch, When switch state changes, Then new value is persisted to SecureStorageService",
          "Given user selects different theme mode, When selection changes, Then new value is persisted to SecureStorageService",
          "Given settings are loading, When SettingsLoading state is emitted, Then LoadingIndicator is displayed",
          "Given an error occurs loading settings, When SettingsError state is emitted, Then ErrorWidget with retry is displayed"
        ]
      },
      {
        "id": "epic-frontend-profile-settings-story-3",
        "title": "Wire up Profile and Settings features in injection_container.dart, app_router.dart, and api_endpoints.dart",
        "description": "Integrate Profile and Settings features into the app infrastructure by updating dependency injection, routing, and API endpoints.\n\nüîí **SCOPE BOUNDARY:**\n- You can ONLY modify files in lib/core/\n- DO NOT create or modify files in lib/features/\n\nüìÅ **FILES:**\n- Read (for context): lib/features/profile/domain/repositories/profile_repository.dart, lib/features/profile/domain/usecases/get_profile_usecase.dart, lib/features/profile/domain/usecases/update_profile_usecase.dart, lib/features/profile/data/datasources/profile_remote_datasource.dart, lib/features/profile/data/repositories/profile_repository_impl.dart, lib/features/profile/presentation/bloc/profile_bloc.dart, lib/features/profile/presentation/pages/profile_page.dart, lib/features/settings/domain/repositories/settings_repository.dart, lib/features/settings/data/repositories/settings_repository_impl.dart, lib/features/settings/presentation/bloc/settings_bloc.dart, lib/features/settings/presentation/pages/settings_page.dart\n- Modify: lib/core/di/injection_container.dart, lib/core/router/app_router.dart, lib/core/network/api_endpoints.dart\n\nüîß **PATTERNS TO USE:**\n\n**Injection Container Pattern (from existing auth/dashboard sections):**\n```dart\n// ============================================================\n// Profile Feature\n// ============================================================\n\n// Data Sources\nsl.registerLazySingleton<ProfileRemoteDatasource>(\n  () => ProfileRemoteDatasourceImpl(client: sl<ApiClient>()),\n);\n\n// Repositories\nsl.registerLazySingleton<ProfileRepository>(\n  () => ProfileRepositoryImpl(\n    datasource: sl<ProfileRemoteDatasource>(),\n  ),\n);\n\n// Use Cases\nsl.registerLazySingleton<GetProfileUseCase>(\n  () => GetProfileUseCase(repository: sl<ProfileRepository>()),\n);\nsl.registerLazySingleton<UpdateProfileUseCase>(\n  () => UpdateProfileUseCase(repository: sl<ProfileRepository>()),\n);\n\n// Blocs (Factory - new instance per use)\nsl.registerFactory<ProfileBloc>(\n  () => ProfileBloc(\n    getProfileUseCase: sl<GetProfileUseCase>(),\n    updateProfileUseCase: sl<UpdateProfileUseCase>(),\n  ),\n);\n\n// ============================================================\n// Settings Feature\n// ============================================================\n\n// Repositories (Settings uses storage only, no remote datasource)\nsl.registerLazySingleton<SettingsRepository>(\n  () => SettingsRepositoryImpl(storage: sl<SecureStorageService>()),\n);\n\n// Blocs (Factory - new instance per use)\nsl.registerFactory<SettingsBloc>(\n  () => SettingsBloc(repository: sl<SettingsRepository>()),\n);\n```\n\n**Router Pattern (from existing routes):**\n```dart\n// Replace placeholder profile route:\nGoRoute(\n  path: RouteNames.profile,\n  name: 'profile',\n  builder: (context, state) => BlocProvider(\n    create: (_) => sl<ProfileBloc>()..add(const ProfileLoadRequested()),\n    child: const ProfilePage(),\n  ),\n),\n\n// Replace placeholder settings route:\nGoRoute(\n  path: RouteNames.settings,\n  name: 'settings',\n  builder: (context, state) => BlocProvider(\n    create: (_) => sl<SettingsBloc>()..add(const SettingsLoadRequested()),\n    child: const SettingsPage(),\n  ),\n),\n```\n\n**API Endpoints (add if not existing):**\nNote: ApiEndpoints.userProfile and ApiEndpoints.updateProfile already exist. Verify they match:\n```dart\n/// GET: Fetch the current user's profile.\nstatic const String userProfile = '/users/profile';\n\n/// PUT: Update the current user's profile.\nstatic const String updateProfile = '/users/profile';\n```\n\n‚ö†Ô∏è **ANTI-PATTERNS TO AVOID:**\n- Registering same service twice - CHECK if already registered\n- Forgetting to add imports at top of file\n- Using registerSingleton for BLoCs - USE registerFactory for BLoCs\n- Leaving _PlaceholderScreen in routes - REPLACE with actual pages\n- Adding routes without BlocProvider wrapper - ALWAYS wrap with BlocProvider\n\nüéØ **FUNCTIONAL REQUIREMENTS:**\n- Profile dependencies registered in injection_container.dart following existing pattern\n- Settings dependencies registered in injection_container.dart following existing pattern\n- Profile route updated to use ProfilePage with ProfileBloc provider\n- Settings route updated to use SettingsPage with SettingsBloc provider\n- Remove _PlaceholderScreen references for profile and settings routes\n- Add required imports for all new classes\n\nüß™ **VERIFICATION:**\n- Run: flutter analyze lib/core/di/injection_container.dart\n- Run: flutter analyze lib/core/router/app_router.dart\n- Check: App compiles without errors: flutter build apk --debug\n- Check: Profile route navigates to ProfilePage (not placeholder)\n- Check: Settings route navigates to SettingsPage (not placeholder)",
        "epicId": "epic-frontend-profile-settings",
        "priority": 2,
        "estimatedComplexity": "simple",
        "dependencies": [
          "epic-frontend-profile-settings-story-1",
          "epic-frontend-profile-settings-story-2"
        ],
        "status": "pending",
        "filesToRead": [
          "lib/features/profile/domain/repositories/profile_repository.dart",
          "lib/features/profile/domain/usecases/get_profile_usecase.dart",
          "lib/features/profile/domain/usecases/update_profile_usecase.dart",
          "lib/features/profile/data/datasources/profile_remote_datasource.dart",
          "lib/features/profile/data/repositories/profile_repository_impl.dart",
          "lib/features/profile/presentation/bloc/profile_bloc.dart",
          "lib/features/profile/presentation/bloc/profile_event.dart",
          "lib/features/profile/presentation/pages/profile_page.dart",
          "lib/features/settings/domain/repositories/settings_repository.dart",
          "lib/features/settings/data/repositories/settings_repository_impl.dart",
          "lib/features/settings/presentation/bloc/settings_bloc.dart",
          "lib/features/settings/presentation/bloc/settings_event.dart",
          "lib/features/settings/presentation/pages/settings_page.dart"
        ],
        "filesToModify": [
          "lib/core/di/injection_container.dart",
          "lib/core/router/app_router.dart",
          "lib/core/network/api_endpoints.dart"
        ],
        "filesToCreate": [],
        "acceptanceCriteria": [
          "Given injection_container.dart is updated, When app initializes, Then ProfileBloc can be resolved via sl<ProfileBloc>()",
          "Given injection_container.dart is updated, When app initializes, Then SettingsBloc can be resolved via sl<SettingsBloc>()",
          "Given app_router.dart is updated, When navigating to /profile, Then ProfilePage is displayed (not placeholder)",
          "Given app_router.dart is updated, When navigating to /settings, Then SettingsPage is displayed (not placeholder)",
          "Given all changes complete, When running flutter analyze, Then no errors are reported",
          "Given all changes complete, When running flutter build apk --debug, Then build succeeds"
        ]
      }
    ]
  }
}